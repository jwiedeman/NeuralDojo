<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neural Garden: Market Forecaster Lab</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="stylesheet" href="../shared/ui.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app">
    <header>
      <div class="title">MARKET ARENA — HISTORICAL FORECAST LAB</div>
      <div class="subtitle">We rotate a 2000 → 2025 multi-asset universe through a streaming forecaster and live trading desk. A compact network learns on rolling windows while the trader ingests its prediction alongside SMA/EMA stacks, RSI, MACD, and volatility regimes.</div>
    </header>

    <main class="split">
      <section class="pane left">
        <div class="panel-header">MARKET PLAYBACK — ACTUAL VS FORECAST</div>
        <canvas id="priceChart" width="540" height="280"></canvas>
        <div class="chart-hint">Orange: actual historical close · Blue: model forecast for the next session.</div>
        <canvas id="errorChart" width="540" height="140"></canvas>
        <div class="chart-hint">Mean absolute error per streaming mini-batch.</div>

        <div class="hud">
          <div>Latest close: <span id="latestActual">—</span></div>
          <div>Model forecast: <span id="latestPred">—</span></div>
          <div>Absolute error: <span id="latestError">—</span></div>
        </div>
        <div class="hud secondary">
          <div>Dataset progress: <span id="datasetProgress">—</span></div>
          <div>Lookback window: <span id="windowSizeLabel">—</span></div>
          <div>Hidden units: <span id="hiddenUnitsLabel">—</span></div>
        </div>

        <div class="panel-sub">Rolling training stats</div>
        <div class="stats compact">
          <div>Steps processed: <span id="stepCount">0</span></div>
          <div>Mean absolute error: <span id="mae">—</span></div>
          <div>Root mean square error: <span id="rmse">—</span></div>
          <div>Best MAE: <span id="bestMae">—</span></div>
          <div>Learning rate: <span id="lrLabel">—</span></div>
          <div>Noise injected: <span id="noiseLabel">—</span></div>
        </div>
      </section>

      <section class="pane right training-pane">
        <div class="panel-header">TIME-SERIES TRAINING LAB</div>
        <div class="training-layout">
          <div class="training-column column-setup">
            <div class="panel-card intro-card">
              <div class="explain">
                <strong>Sequence-in, price-out.</strong> We feed a sliding window of recent closes into a compact tanh MLP and update it after every prediction. No tricks: just stochastic gradient descent nudging the same network forward in time.
              </div>
              <blockquote>
                "Markets are a mathematical collective hallucination." — Inspired by Benoit Mandelbrot
              </blockquote>
            </div>

            <div class="panel-card controls-card">
              <div class="controls row">
                <button id="startBtn">START</button>
                <button id="pauseBtn" disabled>PAUSE</button>
                <button id="resetBtn">RESET NETWORK</button>
              </div>

              <div class="grid-2 compact-grid">
                <div>
                  <div class="label">Learning rate (α)</div>
                  <input type="range" id="learningRate" min="0.005" max="0.200" step="0.005" value="0.050" />
                  <div class="val" id="learningRateVal">0.050</div>
                </div>
                <div>
                  <div class="label">Hidden units</div>
                  <input type="range" id="hiddenUnits" min="4" max="48" step="1" value="18" />
                  <div class="val" id="hiddenUnitsVal">18</div>
                </div>
              </div>

              <div class="grid-2 compact-grid">
                <div>
                  <div class="label">Lookback window</div>
                  <input type="range" id="windowSize" min="8" max="48" step="1" value="24" />
                  <div class="val" id="windowSizeVal">24</div>
                </div>
                <div>
                  <div class="label">Feature noise</div>
                  <input type="range" id="noise" min="0.000" max="0.050" step="0.001" value="0.010" />
                  <div class="val" id="noiseVal">0.010</div>
                </div>
              </div>

              <div class="grid-2 compact-grid">
                <div>
                  <div class="label">Step delay (ms)</div>
                  <input type="range" id="delayMs" min="0" max="300" step="20" value="100" />
                  <div class="val" id="delayMsVal">100</div>
                </div>
                <div class="hint-block">Zero delay = fastest possible training. Raise it to watch learning unfold slowly.</div>
              </div>
            </div>
          </div>

          <div class="training-column column-metrics">
            <div class="panel-card results-card">
              <div class="panel-sub">Recent forecasts</div>
              <ul id="recentList" class="recent-list"></ul>
            </div>

            <div class="panel-card data-card">
              <div class="panel-sub">Dataset feed</div>
              <div class="stats stats-tight">
                <div>Instrument: <span id="instrumentLabel">—</span></div>
                <div>Date range: <span id="datasetDateRange">—</span></div>
                <div>Rotation playlist: <span id="datasetPlaylist">—</span></div>
                <div>Universe size: <span id="datasetUniverse">—</span></div>
                <div>Points streamed: <span id="pointsStreamed">0</span></div>
                <div>Window coverage: <span id="windowCoverage">—</span></div>
                <div>Replay loops: <span id="loopCount">0</span></div>
                <div>Best MAE so far: <span id="bestMaeSecondary">—</span></div>
                <div>Last reset: <span id="lastReset">—</span></div>
              </div>
              <div class="dataset-note">Source: Stooq daily closes (2000 → 2025) rotated across a multi-asset ETF universe (SPY, QQQ, DIA, IWM, EFA, EEM, XLK, XLF, XLE, XLV) sampled 5–10 tickers per replay. The trading agent consumes the forecaster's prediction, actual close, moving-average distances, RSI slopes, MACD momentum, and realized-volatility trends.</div>
            </div>

            <div class="panel-card trading-card">
              <div class="panel-sub">Autonomous trading desk</div>
              <div class="stats stats-tight trading-stats">
                <div>Equity value: <span id="portfolioEquity">—</span></div>
                <div>Cash on hand: <span id="portfolioCash">—</span></div>
                <div>Open position: <span id="portfolioPosition">—</span></div>
                <div>Average cost: <span id="portfolioAvgCost">—</span></div>
                <div>Unrealized P/L: <span id="portfolioUnrealized">—</span></div>
                <div>Realized P/L: <span id="portfolioRealized">—</span></div>
                <div>Total return: <span id="portfolioReturn">—</span></div>
                <div>Max drawdown: <span id="portfolioDrawdown">—</span></div>
                <div>Sharpe ratio: <span id="portfolioSharpe">—</span></div>
                <div>Sortino ratio: <span id="portfolioSortino">—</span></div>
                <div>Calmar ratio: <span id="portfolioCalmar">—</span></div>
                <div>Net CAGR: <span id="portfolioCagr">—</span></div>
                <div>Downside deviation: <span id="portfolioDownside">—</span></div>
                <div>Turnover: <span id="portfolioTurnover">—</span></div>
                <div>Avg win / loss: <span id="portfolioAvgWinLoss">—</span></div>
                <div>Avg hold (days): <span id="portfolioAvgHold">—</span></div>
                <div>Cost drag: <span id="portfolioCostDrag">—</span></div>
                <div>Capacity cost/share: <span id="portfolioCapacity">—</span></div>
                <div>Trades executed: <span id="portfolioTradeCount">—</span></div>
                <div>Win rate: <span id="portfolioWinRate">—</span></div>
                <div>Total costs paid: <span id="portfolioCostsPaid">—</span></div>
                <div>Policy last action: <span id="tradingLastAction" class="policy-metric">—</span></div>
                <div>Policy confidence: <span id="tradingConfidence" class="policy-metric">—</span></div>
                <div>Signal edge: <span id="tradingEdge" class="policy-metric">—</span></div>
                <div>Latest reward: <span id="tradingLastReward" class="policy-metric">—</span></div>
                <div>Avg reward: <span id="tradingAvgReward" class="policy-metric">—</span></div>
                <div>Exploration rate: <span id="tradingExploration" class="policy-metric">—</span></div>
                <div>Completed cycles: <span id="tradingCycleCount" class="policy-metric">—</span></div>
                <div>Last cycle return: <span id="tradingLastCycle" class="policy-metric">—</span></div>
                <div>Best cycle return: <span id="tradingBestCycle" class="policy-metric">—</span></div>
                <div>Lifetime reward: <span id="tradingLifetimeReward" class="policy-metric">—</span></div>
                <div>Cumulative return: <span id="tradingCumulativeReturn" class="policy-metric">—</span></div>
                <div>Trades placed: <span id="tradingTradeCount" class="policy-metric">—</span></div>
                <div>Win rate: <span id="tradingWinRate" class="policy-metric">—</span></div>
                <div>Trend regime: <span id="tradingRegime" class="policy-metric">—</span></div>
                <div>Volatility regime: <span id="tradingVolatility" class="policy-metric">—</span></div>
                <div>Risk controls: <span id="tradingRisk" class="policy-metric">—</span></div>
                <div>Edge guardrails: <span id="tradingThreshold" class="policy-metric">—</span></div>
              </div>
              <div class="panel-sub secondary">Recent orders</div>
              <ul id="tradeLog" class="trade-log"></ul>
              <div class="chart-hint">The agent sizes orders from its forecasts, averaging into strength and trimming into weakness.</div>
            </div>
          </div>

          <div class="training-column column-visuals">
            <div class="panel-card tab-card">
              <div class="panel-sub">Model internals</div>
              <div class="tab-buttons">
                <button class="tab-button active" data-tab="weights">Feature weights</button>
                <button class="tab-button" data-tab="output">Hidden → output</button>
                <button class="tab-button" data-tab="raw">Raw parameters</button>
              </div>
              <div class="tab-panels">
                <div class="tab-panel active" data-tab="weights">
                  <canvas id="weightsCanvas" width="520" height="220"></canvas>
                  <div class="chart-hint">Rows: hidden neurons · Columns: lookback steps. Orange = positive influence · Teal = negative.</div>
                </div>
                <div class="tab-panel" data-tab="output">
                  <canvas id="outputCanvas" width="520" height="120"></canvas>
                  <div class="chart-hint">Contribution of each hidden neuron on the final price prediction.</div>
                </div>
                <div class="tab-panel" data-tab="raw">
                  <details class="weights-raw">
                    <summary>Inspect raw weight tensors</summary>
                    <pre id="weightsRaw">—</pre>
                  </details>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="../shared/ui.js"></script>
  <script src="main.js"></script>
</body>
</html>
